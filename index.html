<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Brawler Game</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background-color: black;
            }
            canvas {
                display: block;
                margin: auto;
                background: url('assets/images/background/background.jpg')
                    no-repeat center center;
                background-size: cover;
            }
            #startOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 24px;
                z-index: 1000;
            }
        </style>
    </head>
    <body>
        <div id="startOverlay">Click or press any key to start</div>
        <canvas id="gameCanvas"></canvas>

        <script>
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 1000;
            canvas.height = 600;

            // Load assets
            const warriorSprite = new Image();
            warriorSprite.src = 'assets/images/warrior/Sprites/Idle.png'; // Idle animation with 8 frames

            const wizardSprite = new Image();
            wizardSprite.src = 'assets/images/wizard/Sprites/Idle.png'; // Idle animation with 8 frames

            const victoryImg = new Image();
            victoryImg.src = 'assets/images/icons/victory.png';

            const swordSound = new Audio('assets/audio/sword.wav');
            const magicSound = new Audio('assets/audio/magic.wav');
            const backgroundMusic = new Audio('assets/audio/music.mp3');
            backgroundMusic.loop = true;
            backgroundMusic.volume = 0.5;

            // Wait for user interaction
            const startOverlay = document.getElementById('startOverlay');
            function startGame() {
                backgroundMusic.play().catch((err) => {
                    console.warn('Autoplay failed:', err);
                });

                startOverlay.style.display = 'none';
                gameLoop();
            }

            window.addEventListener('click', startGame, { once: true });
            window.addEventListener('keydown', startGame, { once: true });

            // Game variables
            const FPS = 60;
            const gravity = 1.5;
            let gameOver = false;

            class Fighter {
                constructor(
                    x,
                    y,
                    sprite,
                    healthBarX,
                    healthBarY,
                    frameWidth,
                    frameHeight,
                    frameCount
                ) {
                    this.x = x;
                    this.y = y;
                    this.sprite = sprite;
                    this.frameWidth = frameWidth; // Width of each frame
                    this.frameHeight = frameHeight; // Height of each frame
                    this.frameCount = frameCount; // Total number of frames
                    this.currentFrame = 0; // Current animation frame
                    this.frameIndex = 0;
                    this.animationSpeed = 5; // Frames to wait before switching to the next frame
                    this.animationCounter = 0; // Counter for timing frame changes
                    this.health = 100;
                    this.isJumping = false;
                    this.velocityY = 0;
                    this.healthBarX = healthBarX;
                    this.healthBarY = healthBarY;
                    this.alive = true;
                }

                draw() {
                    const frameX = this.currentFrame * this.frameWidth; // X-offset for the current frame
                    ctx.drawImage(
                        this.sprite,
                        frameX,
                        0, // Y-offset is 0 as all frames are in one row
                        this.frameWidth,
                        this.frameHeight,
                        this.x,
                        this.y,
                        this.frameWidth,
                        this.frameHeight
                    );
                    this.drawHealthBar();
                    this.animate();
                }

                drawHealthBar() {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.healthBarX, this.healthBarY, 200, 20);
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(
                        this.healthBarX,
                        this.healthBarY,
                        2 * this.health,
                        20
                    );
                }

                animate() {
                    this.animationCounter++;
                    if (this.animationCounter >= this.animationSpeed) {
                        this.currentFrame =
                            (this.currentFrame + 1) % this.frameCount; // Loop through frames
                        this.animationCounter = 0;
                    }
                }

                move(left, right, jumpKey) {
                    if (!this.alive) return;

                    if (keys[left] && this.x > 0) {
                        this.x -= 5;
                    }
                    if (
                        keys[right] &&
                        this.x < canvas.width - this.frameWidth
                    ) {
                        this.x += 5;
                    }
                    if (keys[jumpKey] && !this.isJumping) {
                        this.velocityY = -20;
                        this.isJumping = true;
                    }

                    this.y += this.velocityY;
                    this.velocityY += gravity;

                    if (this.y + this.frameHeight >= canvas.height - 50) {
                        this.y = canvas.height - 50 - this.frameHeight;
                        this.isJumping = false;
                    }
                }

                attack(target) {
                    if (!this.alive || !target.alive) return;

                    const distance = Math.abs(this.x - target.x);
                    if (distance < 100) {
                        target.health -= 10;
                        swordSound.play();
                        if (target.health <= 0) {
                            target.alive = false;
                        }
                    }
                }
            }

            // Initialize fighters
            const warrior = new Fighter(
                100,
                400,
                warriorSprite,
                20,
                20,
                162,
                162,
                8
            ); // Warrior: 8 frames, each 162x162
            const wizard = new Fighter(
                800,
                400,
                wizardSprite,
                canvas.width - 220,
                20,
                250,
                250,
                8
            ); // Wizard: 8 frames, each 250x250

            // Input handling
            const keys = {};
            window.addEventListener('keydown', (e) => {
                keys[e.key] = true;
            });
            window.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });

            // Game loop
            function gameLoop() {
                if (gameOver) {
                    ctx.drawImage(
                        victoryImg,
                        canvas.width / 2 - 150,
                        canvas.height / 3,
                        300,
                        150
                    );
                    return;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Update and draw fighters
                warrior.move('a', 'd', 'w');
                wizard.move('ArrowLeft', 'ArrowRight', 'ArrowUp');

                warrior.draw();
                wizard.draw();

                // Check for game over
                if (!warrior.alive || !wizard.alive) {
                    gameOver = true;
                }

                requestAnimationFrame(gameLoop);
            }
        </script>
    </body>
</html>
