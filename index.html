<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Brawler Game</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background-color: black;
            }
            canvas {
                display: block;
                margin: auto;
                background: url('assets/images/background/background.jpg')
                    no-repeat center center;
                background-size: cover;
            }
            #startOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 24px;
                z-index: 1000;
            }
        </style>
    </head>
    <body>
        <div id="startOverlay">Click or press any key to start</div>
        <canvas id="gameCanvas"></canvas>

        <script>
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 1000;
            canvas.height = 600;

            // Load assets
            const warriorIdleSprite = new Image();
            warriorIdleSprite.src = 'assets/images/warrior/Sprites/Idle.png';

            const warriorAttackSprite = new Image();
            warriorAttackSprite.src =
                'assets/images/warrior/Sprites/Attack1.png';

            const wizardIdleSprite = new Image();
            wizardIdleSprite.src = 'assets/images/wizard/Sprites/Idle.png';

            const wizardAttackSprite = new Image();
            wizardAttackSprite.src = 'assets/images/wizard/Sprites/Attack1.png';

            const victoryImg = new Image();
            victoryImg.src = 'assets/images/icons/victory.png';

            const swordSound = new Audio('assets/audio/sword.wav');
            const magicSound = new Audio('assets/audio/magic.wav');
            const backgroundMusic = new Audio('assets/audio/music.mp3');
            backgroundMusic.loop = true;
            backgroundMusic.volume = 0.5;

            // Wait for user interaction
            const startOverlay = document.getElementById('startOverlay');
            function startGame() {
                backgroundMusic.play().catch((err) => {
                    console.warn('Autoplay failed:', err);
                });

                startOverlay.style.display = 'none';
                gameLoop();
            }

            window.addEventListener('click', startGame, { once: true });
            window.addEventListener('keydown', startGame, { once: true });

            // Game variables
            const FPS = 60;
            const gravity = 1.5;
            let gameOver = false;

            class Fighter {
                constructor(
                    x,
                    y,
                    idleSprite,
                    attackSprite,
                    healthBarX,
                    healthBarY,
                    frameWidth,
                    frameHeight,
                    frameCount,
                    scale
                ) {
                    this.x = x;
                    this.y = y;
                    this.idleSprite = idleSprite;
                    this.attackSprite = attackSprite;
                    this.currentSprite = idleSprite;
                    this.frameWidth = frameWidth;
                    this.frameHeight = frameHeight;
                    this.frameCount = frameCount;
                    this.currentFrame = 0;
                    this.animationSpeed = 5;
                    this.animationCounter = 0;
                    this.health = 100;
                    this.isJumping = false;
                    this.velocityY = 0;
                    this.healthBarX = healthBarX;
                    this.healthBarY = healthBarY;
                    this.alive = true;
                    this.scale = scale;
                    this.isAttacking = false;
                    this.attackCooldown = 0; // Cooldown timer
                    this.hitbox = {
                        x: this.x,
                        y: this.y,
                        width: this.frameWidth * this.scale,
                        height: this.frameHeight * this.scale,
                    };
                }

                draw() {
                    const frameX = this.currentFrame * this.frameWidth;
                    ctx.drawImage(
                        this.currentSprite,
                        frameX,
                        0,
                        this.frameWidth,
                        this.frameHeight,
                        this.x,
                        this.y,
                        this.frameWidth * this.scale,
                        this.frameHeight * this.scale
                    );
                    this.drawHealthBar();
                    this.updateHitbox();
                    this.animate();
                }

                drawHealthBar() {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.healthBarX, this.healthBarY, 200, 20);
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(
                        this.healthBarX,
                        this.healthBarY,
                        2 * this.health,
                        20
                    );
                }

                updateHitbox() {
                    this.hitbox = {
                        x: this.x,
                        y: this.y,
                        width: this.frameWidth * this.scale,
                        height: this.frameHeight * this.scale,
                    };
                }

                animate() {
                    this.animationCounter++;
                    if (this.animationCounter >= this.animationSpeed) {
                        this.currentFrame =
                            (this.currentFrame + 1) % this.frameCount;
                        this.animationCounter = 0;
                    }
                }

                move(left, right, jumpKey) {
                    if (!this.alive) return;

                    if (keys[left] && this.x > 0) {
                        this.x -= 5;
                    }
                    if (
                        keys[right] &&
                        this.x < canvas.width - this.frameWidth * this.scale
                    ) {
                        this.x += 5;
                    }
                    if (keys[jumpKey] && !this.isJumping) {
                        this.velocityY = -20;
                        this.isJumping = true;
                    }

                    this.y += this.velocityY;
                    this.velocityY += gravity;

                    if (
                        this.y + this.frameHeight * this.scale >=
                        canvas.height - 50
                    ) {
                        this.y =
                            canvas.height - 50 - this.frameHeight * this.scale;
                        this.isJumping = false;
                    }
                }

                attack(target) {
                    if (!this.alive || this.attackCooldown > 0) return;

                    this.isAttacking = true;
                    this.currentSprite = this.attackSprite;

                    // Check collision
                    if (
                        this.hitbox.x + this.hitbox.width > target.hitbox.x &&
                        this.hitbox.x < target.hitbox.x + target.hitbox.width &&
                        this.hitbox.y + this.hitbox.height > target.hitbox.y &&
                        this.hitbox.y < target.hitbox.y + target.hitbox.height
                    ) {
                        target.health -= 10;
                        swordSound.play();
                        if (target.health <= 0) {
                            target.alive = false;
                        }
                    }

                    // Reset attack after 500ms
                    setTimeout(() => {
                        this.isAttacking = false;
                        this.currentSprite = this.idleSprite;
                    }, 500);

                    // Start cooldown
                    this.attackCooldown = 30; // Cooldown time
                }

                updateCooldown() {
                    if (this.attackCooldown > 0) {
                        this.attackCooldown--;
                    }
                }
            }

            // Initialize fighters
            const warrior = new Fighter(
                100,
                400,
                warriorIdleSprite,
                warriorAttackSprite,
                20,
                20,
                162,
                162,
                8,
                4
            );
            const wizard = new Fighter(
                800,
                400,
                wizardIdleSprite,
                wizardAttackSprite,
                canvas.width - 220,
                20,
                250,
                250,
                8,
                3
            );

            // Input handling
            const keys = {};
            window.addEventListener('keydown', (e) => {
                keys[e.key] = true;
                if (e.key === 'r') warrior.attack(wizard); // Warrior attack
                if (e.key === 'ArrowDown') wizard.attack(warrior); // Wizard attack
            });
            window.addEventListener('keyup', (e) => {
                keys[e.key] = false;
            });

            // Game loop
            function gameLoop() {
                if (gameOver) {
                    ctx.drawImage(
                        victoryImg,
                        canvas.width / 2 - 150,
                        canvas.height / 3,
                        300,
                        150
                    );
                    return;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Update cooldowns
                warrior.updateCooldown();
                wizard.updateCooldown();

                // Update and draw fighters
                warrior.move('a', 'd', 'w');
                wizard.move('ArrowLeft', 'ArrowRight', 'ArrowUp');

                warrior.draw();
                wizard.draw();

                // Check for game over
                if (!warrior.alive || !wizard.alive) {
                    gameOver = true;
                }

                requestAnimationFrame(gameLoop);
            }
        </script>
    </body>
</html>
